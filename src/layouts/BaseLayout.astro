---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import Visualization from '../components/islands/Visualization';
import ThemeToggle from '../components/ThemeToggle.astro';

interface Props {
  title?: string;
  description?: string;
  isHome?: boolean;
}

const {
  title = 'Simon Bukin',
  description = 'Design engineer building quality user experiences.',
  isHome = false
} = Astro.props;

const pathname = Astro.url.pathname;

const navLinks = [
  { name: 'Writing', href: '/writing' },
  { name: 'Work', href: '/portfolio' },
  { name: 'About', href: '/about' },
];

const socialLinks = [
  { name: 'GitHub', url: 'https://github.com/simonbukin', icon: 'github' },
  { name: 'LinkedIn', url: 'https://linkedin.com/in/simonbukin', icon: 'linkedin' },
  { name: 'Last.fm', url: 'https://last.fm/user/sbukin_', icon: 'music' },
];

---

<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/face.svg" />
    <link rel="canonical" href={Astro.url} />
    <title>{title}</title>

    <!-- Theme flash prevention - runs before CSS loads -->
    <script is:inline>
      // Apply theme immediately on initial load
      (function() {
        var theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
      })();

      // For Astro View Transitions: set theme on the NEW document BEFORE swap
      // This prevents flash by ensuring incoming page already has correct theme
      document.addEventListener('astro:before-swap', function(e) {
        var theme = localStorage.getItem('theme') || 'dark';
        e.newDocument.documentElement.setAttribute('data-theme', theme);
      });
    </script>

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:site_name" content="Simon Bukin" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <ClientRouter fallback="animate" />
  </head>
  <body class="min-h-screen flex flex-col">
    <div transition:persist="visualization" class="hidden lg:block">
      <Visualization client:only="react" />
    </div>

    <!-- Right side overlays (desktop only) -->
    <div class="hidden lg:block fixed top-0 right-0 w-1/2 h-full pointer-events-none z-10">
      <!-- Theme toggle: top-right -->
      <div class="absolute top-6 right-6 pointer-events-auto">
        <ThemeToggle />
      </div>
    </div>
    {!isHome && (
      <header>
        <nav class="max-w-2xl px-6 py-6">
          <a
            href="/"
            class="inline-flex items-center gap-2 text-lg font-semibold transition-colors"
            style="color: var(--text-secondary);"
          >
            Simon Bukin
            <svg class="w-5 h-5 hover:animate-spin" viewBox="0 0 57 38" fill="none">
              <path d="M22.4338 1.94916C22.5821 0.762795 28.4777 1.02453 29.4199 1.02453C30.8261 1.02453 32.209 1.2067 33.5807 1.25569C35.7201 1.3321 37.7237 2.18404 39.7706 2.41147C40.7369 2.51884 41.6712 3.61861 42.3133 4.26073C43.2034 5.15084 44.1934 5.90965 45.0872 6.80346C45.8972 7.61346 46.5449 8.34247 47.1676 9.29481C47.8281 10.3049 48.0218 11.6837 48.7857 12.5824C49.5074 13.4314 49.68 15.0452 49.9929 16.1011C50.349 17.3031 50.635 18.9671 50.635 20.2106C50.635 22.5316 51.281 24.6828 50.224 26.9141C49.1907 29.0956 47.7491 31.5867 45.5495 32.7444C44.3936 33.3528 43.6605 34.3449 42.3647 34.8248C40.7497 35.423 39.246 35.875 37.5618 36.276C33.7373 37.1865 29.7014 36.8539 25.7856 36.8539C21.7519 36.8539 17.2543 36.3386 13.4572 34.9147C10.2624 33.7166 7.3105 31.3917 6.25285 27.9543C5.41314 25.2253 5.33226 22.5188 6.02169 19.7611C7.21304 14.9957 12.1378 11.4044 16.5265 9.8085C17.4563 9.47038 18.7006 9.23704 19.5444 8.76829C20.2658 8.36751 21.7055 7.72808 22.5494 7.72808C24.1834 7.72808 25.8904 6.5723 27.5193 6.5723M20.5846 17.6675C20.8867 17.6675 20.9246 17.6808 21.0469 17.4364M34.4542 15.125H34.9165M16.1924 25.5269C16.1924 27.9664 20.0901 29.2255 21.9714 29.2255C23.0035 29.2255 24.4901 29.4385 25.5543 29.6749C26.7697 29.945 28.3486 29.6878 29.5995 29.6878C30.8369 29.6878 32.2716 29.3041 33.4008 28.9815C34.442 28.684 35.6693 27.9603 36.7654 27.8385C39.4993 27.5347 39.628 24.5848 40.6951 22.9842M6.35268 19.0253C4.71048 19.0253 1 18.8155 1 21.2944C1 21.8044 1.23208 22.1678 1.34909 22.6358C1.45566 23.0621 1.80376 23.2472 2.13453 23.4762C2.52606 23.7473 3.04874 23.7525 3.48887 23.9126C3.80909 24.029 4.18822 24.029 4.53049 24.0289L4.54906 24.0289M50.2215 15.1857C51.5201 15.1857 52.9442 15.1247 54.2069 15.509C54.6532 15.6448 55.0678 15.9929 55.3414 16.3623C55.5998 16.7111 55.9197 16.9901 55.9782 17.458C56.0309 17.8801 55.9896 18.3131 55.8359 18.7057C55.467 19.6486 54.3461 20.1435 53.4764 20.4479C52.8335 20.6729 52.0623 20.6548 51.3851 20.6548" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </a>
          <div class="flex items-center gap-6 mt-4">
            {navLinks.map(link => {
              const isActive = pathname.startsWith(link.href);
              return (
                <a
                  href={link.href}
                  class:list={[
                    "transition-colors",
                    isActive ? "nav-link-active" : "nav-link"
                  ]}
                  aria-current={isActive ? "page" : undefined}
                >
                  {link.name}
                </a>
              );
            })}
          </div>
        </nav>
      </header>
    )}

    <main class="flex-1">
      <slot />
    </main>

    <footer class="mt-auto">
      <div class="max-w-2xl px-6 py-8">
        <div class="flex items-center justify-between gap-4">
          <!-- Social links (always visible) -->
          <div class="flex items-center gap-4">
            {socialLinks.map((link) => (
              <a
                href={link.url}
                target="_blank"
                rel="noopener noreferrer"
                class="hover:opacity-100 transition-colors text-sm"
                style="color: var(--text-tertiary);"
              >
                {link.name}
              </a>
            ))}
          </div>

          <!-- Mobile: theme toggle -->
          <div class="lg:hidden">
            <ThemeToggle />
          </div>
        </div>
      </div>
    </footer>
    <script is:inline>
      (function() {
        if (window.__goofyInit) return;
        window.__goofyInit = true;

        const isGoofy = () => localStorage.getItem('goofy') === 'true';
        const rand = (a,b) => Math.random()*(b-a)+a;
        const pick = a => a[Math.floor(Math.random()*a.length)];
        const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; };

        const COLORS = ['#fafafa','#fca5a5','#fdba74','#fcd34d','#bef264','#86efac','#5eead4','#7dd3fc','#a5b4fc','#c4b5fd','#f0abfc','#fda4af','#ff6b6b','#4ecdc4','#ffe66d'];
        const ANIM_IN = ['goofy-left','goofy-right','goofy-glitch','goofy-slam','goofy-bounce'];
        const ANIM_OUT = ['goofy-out-explode','goofy-out-dissolve','goofy-out-glitch'];

        function getLines(el) {
          const lines=[], range=document.createRange(), walker=document.createTreeWalker(el,NodeFilter.SHOW_TEXT);
          let node,lineTop=null,line=null;
          while((node=walker.nextNode())){
            if(!node.textContent?.trim())continue;
            range.selectNodeContents(node);
            for(const r of range.getClientRects()){
              if(r.width<1||r.height<1)continue;
              if(lineTop===null||Math.abs(r.top-lineTop)>3){
                if(line)lines.push(line);
                lineTop=r.top;
                line={top:r.top,left:r.left,width:r.width,height:r.height};
              }else if(line){
                line.width=Math.max(line.left+line.width,r.left+r.width)-Math.min(line.left,r.left);
                line.left=Math.min(line.left,r.left);
                line.height=Math.max(line.height,r.height);
              }
            }
          }
          if(line)lines.push(line);
          return lines;
        }

        function collectLines() {
          const main=document.querySelector('main');
          if(!main)return[];
          let all=[];
          main.querySelectorAll('h1,h2,h3,h4,h5,h6,p,li,span,a,blockquote,td,th,label,dt,dd').forEach(el=>{
            if(el.closest('pre')||el.closest('code')||el.closest('astro-island'))return;
            if(!el.textContent?.trim())return;
            all.push(...getLines(el));
          });
          main.querySelectorAll('pre,img').forEach(el=>{
            const r=el.getBoundingClientRect();
            if(r.width>1&&r.height>1)all.push({top:r.top,left:r.left,width:r.width,height:r.height});
          });
          all=all.filter((l,i,arr)=>{for(let j=0;j<i;j++)if(Math.abs(arr[j].top-l.top)<3&&Math.abs(arr[j].left-l.left)<5)return false;return true;});
          return shuffle(all).slice(0,80);
        }

        function getContainer() {
          let c=document.getElementById('goofy-container');
          if(!c||!document.body.contains(c)){c=document.createElement('div');c.id='goofy-container';document.body.appendChild(c);}
          return c;
        }

        function clear() {
          const c=document.getElementById('goofy-container');if(c)c.innerHTML='';
          const s=document.getElementById('goofy-scanlines');if(s)s.classList.remove('active');
          document.body.classList.remove('goofy-shake');
        }

        function createOverlays(lines,isOut) {
          const c=getContainer();c.innerHTML='';
          const sy=window.scrollY,sx=window.scrollX;
          return lines.map((l,i)=>{
            const div=document.createElement('div');
            div.className='goofy-overlay';
            const color=pick(COLORS),anim=pick(isOut?ANIM_OUT:ANIM_IN),dur=rand(60,150),delay=rand(0,lines.length*6),rot=rand(-3,3),thick=rand(.8,1.5),extra=rand(0,20);
            div.style.cssText=`top:${l.top+sy}px;left:${l.left+sx-extra/2}px;width:${l.width+extra}px;height:${l.height*thick}px;background:${color};--r:${rot}deg;animation:${anim} ${dur}ms cubic-bezier(.34,1.56,.64,1) ${delay}ms forwards;${isOut?'transform:scaleX(1);':'transform:scaleX(0);'}`;
            if(Math.random()>.7)div.style.boxShadow=`0 0 ${rand(5,15)}px ${color}`;
            c.appendChild(div);
            return {delay,dur};
          });
        }

        function goofyEffects() {
          document.body.classList.add('goofy-shake');
          setTimeout(()=>document.body.classList.remove('goofy-shake'),150);
          let s=document.getElementById('goofy-scanlines');
          if(!s){s=document.createElement('div');s.id='goofy-scanlines';document.body.appendChild(s);}
          s.classList.add('active');
        }

        document.addEventListener('astro:before-preparation',(e)=>{
          if(!isGoofy()||window.matchMedia('(prefers-reduced-motion:reduce)').matches)return;
          const orig=e.loader;
          e.loader=async()=>{
            clear();
            const lines=collectLines();
            if(lines.length){
              goofyEffects();
              const overlays=createOverlays(lines,false);
              const max=Math.max(...overlays.map(o=>o.delay+o.dur))+50;
              await new Promise(r=>setTimeout(r,max));
            }
            await orig();
          };
        });

        document.addEventListener('astro:after-swap',()=>{
          if(!isGoofy()||window.matchMedia('(prefers-reduced-motion:reduce)').matches){clear();return;}
          requestAnimationFrame(()=>requestAnimationFrame(()=>{
            const lines=collectLines();
            if(!lines.length){clear();return;}
            goofyEffects();
            const overlays=createOverlays(lines,true);
            const max=Math.max(...overlays.map(o=>o.delay+o.dur))+100;
            setTimeout(clear,max);
          }));
        });

        document.addEventListener('keydown',(e)=>{
          if(e.shiftKey&&e.key==='G'){
            const on=localStorage.getItem('goofy')!=='true';
            localStorage.setItem('goofy',on);
            console.log('goofy mode:'+(on?'ON':'OFF'));
          }
        });
      })();

      // Pastel link colors
      const pastels = [
        '#fca5a5', '#fdba74', '#fcd34d', '#bef264', '#86efac',
        '#5eead4', '#7dd3fc', '#a5b4fc', '#c4b5fd', '#f0abfc', '#fda4af'
      ];

      function assignColors() {
        document.querySelectorAll('.prose a').forEach(link => {
          const color = pastels[Math.floor(Math.random() * pastels.length)];
          link.style.setProperty('--link-color', color);

          link.addEventListener('mouseenter', () => {
            window.dispatchEvent(new CustomEvent('viz-color', { detail: color }));
          });
          link.addEventListener('mouseleave', () => {
            window.dispatchEvent(new CustomEvent('viz-color-reset'));
          });
        });
      }

      assignColors();
      document.addEventListener('astro:after-swap', assignColors);

      // Image lightbox
      (function() {
        function ensureLightbox() {
          let lightbox = document.getElementById('lightbox');
          if (!lightbox) {
            lightbox = document.createElement('div');
            lightbox.id = 'lightbox';
            lightbox.className = 'lightbox';
            lightbox.innerHTML = '<img src="" alt="" />';
            document.body.appendChild(lightbox);

            lightbox.addEventListener('click', () => {
              lightbox.classList.remove('active');
              document.body.style.overflow = '';
            });
          }
          return lightbox;
        }

        function openLightbox(src, alt) {
          const lightbox = ensureLightbox();
          const lightboxImg = lightbox.querySelector('img');
          lightboxImg.src = src;
          lightboxImg.alt = alt;
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const lightbox = document.getElementById('lightbox');
            if (lightbox) {
              lightbox.classList.remove('active');
              document.body.style.overflow = '';
            }
          }
        });

        function attachLightbox() {
          ensureLightbox();
          document.querySelectorAll('.prose img').forEach(img => {
            if (img.dataset.lightboxAttached) return;
            img.dataset.lightboxAttached = 'true';
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              openLightbox(img.src, img.alt);
            });
          });
        }

        // Run on initial load and after navigation
        attachLightbox();
        document.addEventListener('astro:after-swap', attachLightbox);
        document.addEventListener('astro:page-load', attachLightbox);
      })();

      // Image link hover preview
      (function() {
        function ensurePreview() {
          let preview = document.getElementById('image-preview');
          if (!preview) {
            preview = document.createElement('div');
            preview.id = 'image-preview';
            preview.className = 'image-preview';
            preview.innerHTML = '<img src="" alt="" />';
            document.body.appendChild(preview);
          }
          return preview;
        }

        const imageExtensions = /\.(png|jpg|jpeg|gif|webp|svg)$/i;

        function showPreview(e, src) {
          const preview = ensurePreview();
          const previewImg = preview.querySelector('img');
          previewImg.src = src;
          preview.classList.add('active');
          updatePosition(e);
        }

        function hidePreview() {
          const preview = document.getElementById('image-preview');
          if (preview) preview.classList.remove('active');
        }

        function updatePosition(e) {
          const preview = document.getElementById('image-preview');
          if (!preview) return;

          const padding = 16;
          let x = e.clientX + padding;
          let y = e.clientY + padding;

          // Keep preview in viewport
          const previewRect = preview.getBoundingClientRect();
          if (x + previewRect.width > window.innerWidth) {
            x = e.clientX - previewRect.width - padding;
          }
          if (y + previewRect.height > window.innerHeight) {
            y = e.clientY - previewRect.height - padding;
          }

          preview.style.left = x + 'px';
          preview.style.top = y + 'px';
        }

        function attachPreviews() {
          ensurePreview();
          document.querySelectorAll('.prose a').forEach(link => {
            if (link.dataset.previewAttached) return;
            link.dataset.previewAttached = 'true';

            const href = link.getAttribute('href') || '';
            const previewUrl = link.dataset.preview || (imageExtensions.test(href) ? href : null);

            if (previewUrl) {
              link.addEventListener('mouseenter', (e) => showPreview(e, previewUrl));
              link.addEventListener('mousemove', updatePosition);
              link.addEventListener('mouseleave', hidePreview);
            }
          });
        }

        // Run on initial load and after navigation
        attachPreviews();
        document.addEventListener('astro:after-swap', attachPreviews);
        document.addEventListener('astro:page-load', attachPreviews);
      })();
    </script>
  </body>
</html>
